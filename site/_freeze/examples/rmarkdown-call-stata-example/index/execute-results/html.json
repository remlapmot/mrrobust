{
  "hash": "8e44a4ece6e1ddb188b3f86a5751751a",
  "result": {
    "engine": "knitr",
    "markdown": "---\nengine: knitr\n---\n\n\n\n\n# How to include mrrobust Stata code in an R Markdown or Quarto document using the Statamarkdown R package\n\n## Introduction\n\nThis example shows how to run R and Stata code within the same R Markdown (_.Rmd_) or Quarto (_.qmd_) file using the **Statamarkdown** R package. More information about this package is available [here](https://github.com/Hemken/Statamarkdown) and [here](https://www.ssc.wisc.edu/~hemken/Stataworkshops/Statamarkdown/stata-and-r-markdown.html). To install this package run the following in R.\n\n```r\ninstall.packages(\"Statamarkdown\")\n```\n\nNote when writing our Stata code chunks we need to be careful when we specify the `collectcode=TRUE` code chunk option, because each Stata code chunk is run as a separate batch job. For example, we include this chunk option in a chunk which reads in a dataset which we wish to use in subsequent chunks.\n\nUsing R and Stata code in the same script means that we can use the functions provided by the [**TwoSampleMR**](https://github.com/MRCIEU/TwoSampleMR) package to obtain data from the [OpenGWAS API](https://api.opengwas.io/), which is the successor to [MR-Base](https://www.mrbase.org/) [@mrbase].\n\nThe OpenGWAS API requires authentication. You must place an `OPENGWAS_JWT` token (by creating a free account on <https://api.opengwas.io/profile/>) in your _.Renviron_ file before running the code below. See the [**ieugwasr** website](https://mrcieu.github.io/ieugwasr/articles/guide.html#authentication) for more information.\n\nNext we install the other required packages in R.\n\n```r\ninstall.packages(\n  \"TwoSampleMR\",\n  repos = c(\n    \"https://mrcieu.r-universe.dev\",\n    \"https://cloud.r-project.org\"\n  ),\n  dependencies = TRUE\n)\ninstall.packages(\"foreign\")\n```\n\n## Example R Markdown or Quarto document\n\nSave the following code chunk as an _.Rmd_ or _.qmd_ file, e.g. _myanalysis.Rmd_.\n\n\n\n\n\n````{.markdown}\n---\ntitle: Using mrrobust in an R Markdown or Quarto document\n---\n\n## Extracting data from MR-Base\n\nWe will be running the script from the MR-Base paper \n([Hemani et al., 2018](https://doi.org/10.7554/eLife.34408)).\nThe R code we will use is from\n[here](https://raw.githubusercontent.com/explodecomputer/mr-base-methods-paper/master/scripts/ldl-chd.R).\n\nWe load the packages into our R session.\nNote that the **foreign** package provides the `write.dta()` function\nwhich we will use to save the data in Stata format.\n\n```{r}\nlibrary(TwoSampleMR)\nlibrary(MRInstruments)\nlibrary(foreign)\nlibrary(Statamarkdown)\n```\n\nWe can access the data using the **MRInstruments** package.\n\n```{r}\ndata(gwas_catalog)\n\n# Get published SNPs for LDL cholesterol\nldl_snps <-\n  subset(gwas_catalog,\n    grepl(\"LDL choles\", Phenotype) & Author == \"Willer CJ\")$SNP\n\n# Extract from GLGC dataset\nexposure <-\n  convert_outcome_to_exposure(\n    extract_outcome_data(ldl_snps, \"ieu-a-300\"))\n\n# Get outcome data from Cardiogram 2015\noutcome <- extract_outcome_data(exposure$SNP, \"ieu-a-7\")\n\n# Harmonise exposure and outcome datasets\n# Assume alleles are on the forward strand\ndat <- harmonise_data(exposure, outcome, action = 1)\n```\n\nAt this point we have our harmonised genotype-exposure and genotype-outcome\nassociation data saved in an object in our R session called `dat`.\n\nThe next two code chunks perform the analysis in R.\n\n```{r}\n# Perform MR analysis\nmr(dat)\nmr_heterogeneity(dat)\ndat$exposure <- \"LDL cholesterol\"\ndat$outcome <- \"Coronary heart disease\"\n\n# Label outliers and create plots\ndat$labels <- dat$SNP\ndat$labels[! dat$SNP %in% c(\"rs11065987\", \"rs1250229\", \"rs4530754\")] <- NA\n```\n\nTo proceed in Stata we can save our `dat` object as a Stata dataset\n\n```{r}\nwrite.dta(dat, file = \"dat.dta\")\n```\n\n## Analysis in Stata using the mrrobust package\n\nAt this point in Stata install the **mrrobust** package and its\ndependencies if you have not done so previously.\n\n```stata\nnet install github, from(\"https://haghish.github.io/github/\")\ngitget mrrobust\n```\n\nWe now read the dataset into Stata and look at the variable names\nand the number of observations.\n\n```{stata, collectcode=TRUE}\nqui use dat, clear\n```\n\n```{stata}\nds, v(28)\n```\n\n```{stata}\ndi _N\n```\n\nWe can then run the IVW model using `mregger` with fixed effect standard errors.\n\n```{stata}\nmregger beta_outcome beta_exposure [aw=1/(se_outcome^2)], ivw fe\n```\n\nWe then fit the MR-Egger, median, and modal based estimators.\n\n```{stata}\nmregger beta_outcome beta_exposure [aw=1/(se_outcome^2)]\n```\n\n```{stata}\nmrmedian beta_outcome se_outcome beta_exposure se_exposure, weighted\n```\n\n```{stata}\nmrmodal beta_outcome se_outcome beta_exposure se_exposure, weighted\n```\n\nAnd we could continue with additional Stata code (or indeed R code) as we like.\n````\n\n\n\n\nTo render your R Markdown file, either; open it in RStudio and click the `Knit` button in the toolbar of the Source code window, or run\n\n```r\nrmarkdown::render('myanalysis.Rmd')\n```\n\nor to render a Quarto file run the following in your Terminal\n\n```sh\nquarto render myanalysis.qmd\n```\n\n## References\n\n::: {#refs}\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}